<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ê´€ìƒ & ì˜¤ëŠ˜ì˜ ìš´ì„¸</title>
    <style>
        /* Google Fonts Noto Sans KR */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');

        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 1rem;
            box-sizing: border-box;
        }

        /* ì•± ì „ì²´ ì»¨í…Œì´ë„ˆ */
        .app-container {
            width: 100%;
            max-width: 420px;
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }

        /* ê° í™”ë©´ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .screen {
            padding: 30px;
            text-align: center;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 10px;
        }
        
        h2 {
            font-size: 20px;
            color: #0056b3;
            border-bottom: 2px solid #0056b3;
            padding-bottom: 5px;
            margin-top: 30px;
            margin-bottom: 15px;
        }
        
        p {
            font-size: 16px;
            line-height: 1.6;
            color: #555;
            margin-bottom: 25px;
        }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px 0 rgba(0, 123, 255, 0.3);
            width: 100%;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(0, 123, 255, 0.4);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* í™”ë©´ ìˆ¨ê¹€ ì²˜ë¦¬ */
        .hidden {
            display: none;
        }

        /* ì¹´ë©”ë¼ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #camera-container {
            position: relative;
            width: 100%;
            max-width: 360px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
        }

        #webcam {
            width: 100%;
            height: auto;
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
        }

        #overlay-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: scaleX(-1); /* ê±°ìš¸ ëª¨ë“œ */
        }

        /* ë¡œë”© í™”ë©´ ìŠ¤íƒ€ì¼ */
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #007bff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ê²°ê³¼ í™”ë©´ ìŠ¤íƒ€ì¼ */
        #result-screen {
            text-align: left;
        }
        
        .result-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .result-section h3 {
            font-size: 16px;
            font-weight: 700;
            margin: 0 0 10px 0;
            color: #333;
        }
        
        .result-section p {
            font-size: 15px;
            margin: 0;
            color: #555;
            line-height: 1.5;
            white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ì ìš© */
        }
        
        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 10px;
            border-radius: 5px;
            margin-top: 15px;
        }

    </style>
</head>
<body>

    <div class="app-container">
        <!-- ì‹œì‘ í™”ë©´ -->
        <div id="start-screen" class="screen">
            <h1>AI ê´€ìƒ & ì˜¤ëŠ˜ì˜ ìš´ì„¸</h1>
            <p>ì¹´ë©”ë¼ë¡œ ì–¼êµ´ì„ ë¹„ì¶”ë©´ AIê°€ ë‹¹ì‹ ì˜ ê´€ìƒì„ ë¶„ì„í•˜ê³  ì˜¤ëŠ˜ì˜ ìš´ì„¸ë¥¼ ì•Œë ¤ë“œë¦½ë‹ˆë‹¤.</p>
            <p style="font-size: 12px; color: #888;">âš ï¸ ë¶„ì„ì€ ë¸Œë¼ìš°ì € ë‚´ì—ì„œë§Œ ì´ë£¨ì–´ì§€ë©°, ì–´ë–¤ ì´ë¯¸ì§€ë„ ì„œë²„ë¡œ ì „ì†¡ë˜ê±°ë‚˜ ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
            <button id="start-btn" class="btn">ì‹œì‘í•˜ê¸°</button>
        </div>

        <!-- ì¹´ë©”ë¼ ì´¬ì˜ í™”ë©´ -->
        <div id="camera-screen" class="screen hidden">
            <h1>ì–¼êµ´ì„ ë¹„ì¶°ì£¼ì„¸ìš”</h1>
            <p>ì–¼êµ´ì´ ì¸ì‹ë˜ë©´ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
            <div id="camera-container">
                <video id="webcam" autoplay playsinline></video>
                <canvas id="overlay-canvas"></canvas>
            </div>
            <button id="capture-btn" class="btn" disabled>ë¶„ì„í•˜ê¸°</button>
        </div>

        <!-- ë¡œë”© í™”ë©´ -->
        <div id="loading-screen" class="screen hidden">
            <h1>AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤</h1>
            <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
            <div class="loader"></div>
        </div>

        <!-- ê²°ê³¼ í™”ë©´ -->
        <div id="result-screen" class="screen hidden">
            <h2>ğŸ§ ê´€ìƒ ë¶„ì„ ê²°ê³¼</h2>
            <div id="physiognomy-results"></div>
            
            <h2>âœ¨ ì˜¤ëŠ˜ì˜ ìš´ì„¸</h2>
            <div id="fortune-results"></div>

            <div id="error-display" class="error-message hidden"></div>
            <button id="retry-btn" class="btn">ë‹¤ì‹œí•˜ê¸°</button>
        </div>
    </div>

    <!-- MediaPipe Face Landmarker ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import {
            FaceLandmarker,
            FilesetResolver
        } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        // DOM ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
        const startScreen = document.getElementById('start-screen');
        const cameraScreen = document.getElementById('camera-screen');
        const loadingScreen = document.getElementById('loading-screen');
        const resultScreen = document.getElementById('result-screen');

        const startBtn = document.getElementById('start-btn');
        const captureBtn = document.getElementById('capture-btn');
        const retryBtn = document.getElementById('retry-btn');

        const video = document.getElementById("webcam");
        const canvasElement = document.getElementById("overlay-canvas");
        const canvasCtx = canvasElement.getContext("2d");
        
        const physiognomyResultsEl = document.getElementById('physiognomy-results');
        const fortuneResultsEl = document.getElementById('fortune-results');
        const errorDisplayEl = document.getElementById('error-display');

        let faceLandmarker;
        let runningMode = "VIDEO";
        let lastVideoTime = -1;
        let faceLandmarks;

        // MediaPipe FaceLandmarker ì´ˆê¸°í™”
        async function createFaceLandmarker() {
            const filesetResolver = await FilesetResolver.forVisionTasks(
                "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm"
            );
            faceLandmarker = await FaceLandmarker.createFromOptions(filesetResolver, {
                baseOptions: {
                    modelAssetPath: `https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task`,
                    delegate: "GPU"
                },
                outputFaceBlendshapes: true,
                runningMode,
                numFaces: 1
            });
            startBtn.disabled = false;
            startBtn.innerText = "ì‹œì‘í•˜ê¸°";
        }
        
        // ì‹œì‘ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í…ìŠ¤íŠ¸ ì„¤ì •
        startBtn.disabled = true;
        startBtn.innerText = "AI ëª¨ë¸ ë¡œë”© ì¤‘...";
        createFaceLandmarker();

        // ì›¹ìº  ì‹œì‘ í•¨ìˆ˜
        async function startWebcam() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                video.addEventListener("loadeddata", predictWebcam);
            } catch (err) {
                console.error("ì›¹ìº  ì ‘ê·¼ ì˜¤ë¥˜:", err);
                alert("ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ì¹´ë©”ë¼ ì ‘ê·¼ì„ í—ˆìš©í•´ì£¼ì„¸ìš”.");
                // í™”ë©´ ì´ˆê¸°í™”
                cameraScreen.classList.add('hidden');
                startScreen.classList.remove('hidden');
            }
        }

        // ì‹¤ì‹œê°„ ì–¼êµ´ íŠ¹ì§•ì  ì˜ˆì¸¡ í•¨ìˆ˜
        async function predictWebcam() {
            if (video.videoWidth === 0) {
                requestAnimationFrame(predictWebcam);
                return;
            }
            
            canvasElement.width = video.videoWidth;
            canvasElement.height = video.videoHeight;
            
            let startTimeMs = performance.now();
            if (lastVideoTime !== video.currentTime) {
                lastVideoTime = video.currentTime;
                const results = faceLandmarker.detectForVideo(video, startTimeMs);
                faceLandmarks = results.faceLandmarks;
            }

            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            if (faceLandmarks && faceLandmarks.length > 0) {
                // ì–¼êµ´ íŠ¹ì§•ì  ê·¸ë¦¬ê¸°
                for (const landmarks of faceLandmarks) {
                    // ì–¼êµ´ ìœ¤ê³½ì„ 
                    drawConnectors(canvasCtx, landmarks, FaceLandmarker.FACE_LANDMARKS_TESSELATION, { color: "rgba(0, 255, 255, 0.5)", lineWidth: 0.5 });
                    // ëˆˆì¹
                    drawConnectors(canvasCtx, landmarks, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYEBROW, { color: "rgba(255, 255, 0, 0.7)" });
                    drawConnectors(canvasCtx, landmarks, FaceLandmarker.FACE_LANDMARKS_LEFT_EYEBROW, { color: "rgba(255, 255, 0, 0.7)" });
                    // ëˆˆ
                    drawConnectors(canvasCtx, landmarks, FaceLandmarker.FACE_LANDMARKS_RIGHT_EYE, { color: "rgba(0, 255, 0, 0.7)" });
                    drawConnectors(canvasCtx, landmarks, FaceLandmarker.FACE_LANDMARKS_LEFT_EYE, { color: "rgba(0, 255, 0, 0.7)" });
                    // ì…ìˆ 
                    drawConnectors(canvasCtx, landmarks, FaceLandmarker.FACE_LANDMARKS_LIPS, { color: "rgba(255, 0, 0, 0.7)" });
                }
                captureBtn.disabled = false;
                captureBtn.innerText = "ë¶„ì„í•˜ê¸°";
            } else {
                captureBtn.disabled = true;
                captureBtn.innerText = "ì–¼êµ´ì„ ì¸ì‹ì‹œì¼œì£¼ì„¸ìš”";
            }
            
            if (runningMode === "VIDEO") {
                window.requestAnimationFrame(predictWebcam);
            }
        }
        
        // íŠ¹ì§•ì  ì—°ê²°ì„  ê·¸ë¦¬ê¸° í—¬í¼ í•¨ìˆ˜
        function drawConnectors(ctx, landmarks, connectors, options) {
            ctx.beginPath();
            for (const connector of connectors) {
                const start = landmarks[connector.start];
                const end = landmarks[connector.end];
                ctx.moveTo(start.x * canvasElement.width, start.y * canvasElement.height);
                ctx.lineTo(end.x * canvasElement.width, end.y * canvasElement.height);
            }
            ctx.lineWidth = options.lineWidth || 2;
            ctx.strokeStyle = options.color || "#FFFFFF";
            ctx.stroke();
        }

        // ì–¼êµ´ íŠ¹ì§•ì„ ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ë¡œ ë¶„ì„í•˜ëŠ” í•¨ìˆ˜
        function analyzeFaceFeatures(landmarks) {
            if (!landmarks || landmarks.length === 0) return "ì–¼êµ´ íŠ¹ì§•ì„ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
            
            const lm = landmarks[0];
            let analysis = [];

            // 1. ì–¼êµ´í˜• (ìƒ/ì¤‘/í•˜ì•ˆë¶€ ë¹„ìœ¨)
            const foreheadTop = lm[10]; // ì´ë§ˆ ìœ„
            const eyebrowMid = lm[105]; // ë¯¸ê°„
            const noseBottom = lm[2];   // ì½” ë
            const chinBottom = lm[152]; // í„± ë
            
            const upperFace = Math.abs(foreheadTop.y - eyebrowMid.y);
            const middleFace = Math.abs(eyebrowMid.y - noseBottom.y);
            const lowerFace = Math.abs(noseBottom.y - chinBottom.y);
            const total = upperFace + middleFace + lowerFace;

            const upperRatio = (upperFace / total * 100).toFixed(1);
            const middleRatio = (middleFace / total * 100).toFixed(1);
            const lowerRatio = (lowerFace / total * 100).toFixed(1);

            analysis.push(`- ì–¼êµ´ ë¹„ìœ¨: ìƒì•ˆë¶€ ${upperRatio}%, ì¤‘ì•ˆë¶€ ${middleRatio}%, í•˜ì•ˆë¶€ ${lowerRatio}%ë¡œ ê· í˜•ì´ ì˜ ì¡í˜€ ìˆìŠµë‹ˆë‹¤.`);
            if(upperRatio > 35) analysis.push("- ì´ë§ˆê°€ ë„“ì–´ ì§€ì ì´ê³  ì°½ì˜ì ì¸ ë©´ëª¨ë¥¼ ë³´ì…ë‹ˆë‹¤.");
            if(middleRatio > 35) analysis.push("- ì¤‘ì•ˆë¶€ê°€ ë°œë‹¬í•˜ì—¬ ìì¡´ì‹¬ê³¼ ì‹¤í–‰ë ¥ì´ ê°•í•©ë‹ˆë‹¤.");
            if(lowerRatio > 35) analysis.push("- í•˜ê´€ì´ ë°œë‹¬í•˜ì—¬ ì˜ì§€ë ¥ì´ ê°•í•˜ê³  ë§ë…„ìš´ì´ ì¢‹ìŠµë‹ˆë‹¤.");

            // 2. ëˆˆì¹ ëª¨ì–‘ (ê¸°ìš¸ê¸°)
            const leftEyebrowOuter = lm[283];
            const leftEyebrowInner = lm[300];
            const eyebrowTilt = (leftEyebrowInner.y - leftEyebrowOuter.y).toFixed(3);
            if(eyebrowTilt > 0.01) analysis.push("- ëˆˆì¹ ëì´ ì˜¬ë¼ê°€ ìˆì–´ ê¸ì •ì ì´ê³  ì§„ì·¨ì ì¸ ì„±í–¥ì…ë‹ˆë‹¤.");
            else if (eyebrowTilt < -0.01) analysis.push("- ëˆˆì¹ ëì´ ë‚´ë ¤ê°€ ìˆì–´ ì˜¨í™”í•˜ê³  ì‚¬ë ¤ ê¹Šì€ ì„±í’ˆì…ë‹ˆë‹¤.");
            else analysis.push("- ëˆˆì¹ì´ ìˆ˜í‰ì— ê°€ê¹Œì›Œ ì´ì„±ì ì´ê³  ì•ˆì •ì ì¸ ì„±í–¥ì…ë‹ˆë‹¤.");

            // 3. ì…ê¼¬ë¦¬ ëª¨ì–‘
            const lipCornerLeft = lm[61];
            const lipCornerRight = lm[291];
            const lipCenter = lm[13];
            const mouthCornerAvgY = (lipCornerLeft.y + lipCornerRight.y) / 2;
            if(mouthCornerAvgY < lipCenter.y) analysis.push("- ì…ê¼¬ë¦¬ê°€ ì˜¬ë¼ê°€ ìˆì–´ ë‚™ì²œì ì´ê³  ëŒ€ì¸ê´€ê³„ê°€ ì›ë§Œí•©ë‹ˆë‹¤.");
            else analysis.push("- ì…ê¼¬ë¦¬ê°€ ì²˜ì ¸ ë³´ì¼ ìˆ˜ ìˆìœ¼ë‚˜, ì‹ ì¤‘í•˜ê³  ì±…ì„ê°ì´ ê°•í•œ ë©´ëª¨ë¥¼ ë³´ì…ë‹ˆë‹¤.");
            
            return analysis.join("\n");
        }

        // Gemini APIë¥¼ í˜¸ì¶œí•˜ì—¬ ìš´ì„¸ ìƒì„±
        async function getFortuneFromLLM(analysisText) {
            const apiKey = ""; // Gemini API í‚¤ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”.
            if (!apiKey) {
                console.warn("Gemini API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìƒ˜í”Œ ì‘ë‹µì„ ì‚¬ìš©í•©ë‹ˆë‹¤.");
                return {
                    physiognomy: "AIê°€ ë¶„ì„í•œ ë‹¹ì‹ ì˜ ê´€ìƒì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤:\n" + analysisText,
                    fortune: "âœ¨ ì˜¤ëŠ˜ì˜ ìš´ì„¸ âœ¨\n\nì¢…í•©ìš´: AI ì—”ì§„ì´ í™œê¸°ì°¨ê²Œ ëŒì•„ê°€ëŠ” ê²ƒì²˜ëŸ¼, ë‹¹ì‹ ì˜ ì—ë„ˆì§€ë„ ìµœê³ ì¡°ì— ë‹¬í•˜ëŠ” ë‚ ì…ë‹ˆë‹¤. ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•˜ê¸°ì— ì™„ë²½í•œ í•˜ë£¨!\n\nì¬ë¬¼ìš´: ëœ»ë°–ì˜ ì¥ì†Œì—ì„œ ì‘ì€ í–‰ìš´(ì˜ˆ: ìŠê³  ìˆë˜ ë¹„ìƒê¸ˆ)ì„ ë°œê²¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nì• ì •ìš´: ë‹¹ì‹ ì˜ ë¯¸ì†ŒëŠ” ìµœê³ ì˜ ì•Œê³ ë¦¬ì¦˜! ê¸ì •ì ì¸ í‘œì • í•˜ë‚˜ë¡œ ì£¼ë³€ ì‚¬ëŒë“¤ì˜ í˜¸ê°ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
                };
            }
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            
            const prompt = `
ë‹¹ì‹ ì€ ìœ ë¨¸ëŸ¬ìŠ¤í•˜ê³  ê¸ì •ì ì¸ ê¸°ìš´ì„ ì£¼ëŠ” AI ê´€ìƒê°€ì´ì ìš´ì„¸ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ì•„ë˜ì˜ ì–¼êµ´ íŠ¹ì§• ë¶„ì„ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ, í•œ ì‚¬ëŒì„ ìœ„í•œ 'ê´€ìƒ ë¶„ì„ ê²°ê³¼'ì™€ 'ì˜¤ëŠ˜ì˜ ìš´ì„¸'ë¥¼ ìƒì„¸í•˜ê³  ì¬ë¯¸ìˆê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.

[ì–¼êµ´ íŠ¹ì§• ë¶„ì„ ë°ì´í„°]
${analysisText}

[ì‘ì„± ê·œì¹™]
1.  **ê´€ìƒ ë¶„ì„ ê²°ê³¼**: ë¶„ì„ ë°ì´í„°ë¥¼ ìì—°ìŠ¤ëŸ¬ìš´ ë¬¸ì¥ìœ¼ë¡œ í’€ì–´ì„œ ì„¤ëª…í•´ì£¼ì„¸ìš”. ê¸ì •ì ì¸ ë©´ì„ ë¶€ê°í•´ì„œ ì´ì•¼ê¸°í•´ì£¼ì„¸ìš”.
2.  **ì˜¤ëŠ˜ì˜ ìš´ì„¸**: 'ì¢…í•©ìš´', 'ì¬ë¬¼ìš´', 'ì• ì •ìš´' ì„¸ ê°€ì§€ í•­ëª©ìœ¼ë¡œ ë‚˜ëˆ„ì–´ êµ¬ì²´ì ì´ê³  í¬ë§ì ì¸ ë©”ì‹œì§€ë¥¼ ë‹´ì•„ ì‘ì„±í•´ì£¼ì„¸ìš”.
3.  ì „ì²´ì ìœ¼ë¡œ ì¹œê·¼í•˜ê³  ë”°ëœ»í•œ ë§íˆ¬ë¥¼ ì‚¬ìš©í•´ì£¼ì„¸ìš”.
4.  ê²°ê³¼ëŠ” JSON í˜•ì‹ìœ¼ë¡œ, 'physiognomy'ì™€ 'fortune' ë‘ ê°œì˜ í‚¤ë¥¼ ê°€ì§„ ê°ì²´ë¡œ ë°˜í™˜í•´ì£¼ì„¸ìš”.

ì˜ˆì‹œ JSON ì¶œë ¥:
{
  "physiognomy": "ì–¼êµ´ ë¹„ìœ¨ì´ ì¡°í™”ë¡­ê³  ëˆˆì¹ì—ì„œ ì§„ì·¨ì ì¸ ê¸°ìƒì´ ëŠê»´ì§‘ë‹ˆë‹¤. ì´ëŠ”...",
  "fortune": "ì¢…í•©ìš´: ...\\nì¬ë¬¼ìš´: ...\\nì• ì •ìš´: ..."
}
`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        generationConfig: {
                           responseMimeType: "application/json",
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const text = data.candidates[0].content.parts[0].text;
                return JSON.parse(text);

            } catch (error) {
                console.error("Gemini API í˜¸ì¶œ ì˜¤ë¥˜:", error);
                errorDisplayEl.innerText = `ìš´ì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`;
                errorDisplayEl.classList.remove('hidden');
                return null;
            }
        }
        
        // ê²°ê³¼ ë Œë”ë§ í•¨ìˆ˜
        function renderResult(data, key, element) {
            element.innerHTML = ''; // ê¸°ì¡´ ë‚´ìš© ì´ˆê¸°í™”
            const p = document.createElement('p');
            p.innerText = data;
            const section = document.createElement('div');
            section.className = 'result-section';
            section.appendChild(p);
            element.appendChild(section);
        }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

        // ì‹œì‘ ë²„íŠ¼
        startBtn.addEventListener('click', () => {
            startScreen.classList.add('hidden');
            cameraScreen.classList.remove('hidden');
            startWebcam();
        });

        // ë¶„ì„í•˜ê¸° ë²„íŠ¼
        captureBtn.addEventListener('click', async () => {
            runningMode = "IMAGE"; // ì˜ˆì¸¡ ë£¨í”„ ì¤‘ë‹¨
            video.pause();
            
            cameraScreen.classList.add('hidden');
            loadingScreen.classList.remove('hidden');
            
            // 1. ì–¼êµ´ íŠ¹ì§• í…ìŠ¤íŠ¸ ë¶„ì„
            const analysisText = analyzeFaceFeatures(faceLandmarks);
            
            // 2. Gemini APIë¡œ ìš´ì„¸ ìƒì„±
            const fortuneData = await getFortuneFromLLM(analysisText);
            
            loadingScreen.classList.add('hidden');
            resultScreen.classList.remove('hidden');

            // 3. ê²°ê³¼ í‘œì‹œ
            if (fortuneData) {
                renderResult(fortuneData.physiognomy, 'physiognomy', physiognomyResultsEl);
                renderResult(fortuneData.fortune, 'fortune', fortuneResultsEl);
                errorDisplayEl.classList.add('hidden');
            } else {
                // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ í…ìŠ¤íŠ¸ í‘œì‹œ
                physiognomyResultsEl.innerHTML = '<p>ê´€ìƒ ë¶„ì„ ê²°ê³¼ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
                fortuneResultsEl.innerHTML = '<p>ì˜¤ëŠ˜ì˜ ìš´ì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        });

        // ë‹¤ì‹œí•˜ê¸° ë²„íŠ¼
        retryBtn.addEventListener('click', () => {
            resultScreen.classList.add('hidden');
            startScreen.classList.remove('hidden');
            
            // ì›¹ìº  ìŠ¤íŠ¸ë¦¼ ì •ì§€
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
            }
            runningMode = "VIDEO"; // ëª¨ë“œ ì´ˆê¸°í™”
        });

    </script>
</body>
</html>
